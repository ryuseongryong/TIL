# PostgreSQL High Availability using pgpool-II
- https://www.postgresql.fastware.com/postgresql-insider-ha-pgpool-ii

- 엔터프라이즈 데이터베이스 시스템은 고가용성을 요구한다. 시스템은 장애를 견디고 항상 안정적으로 작동해야 한다. 시스템이 발전함에 따라 서버를 추가할 수 있도록 확장성도 마찬가지로 중요하다. 데이터 볼륨이나 액세스가 증가하더라도 응답 속도와 처리 용량을 유지해야 한다.
- 이 글은 PostgreSQL 오픈소스 확장 중 하나인 pgpool-II를 사용한 고가용성 시스템 설정에 대해 설명한다. 이 솔루션은 고가용성과 확장성이라는 두 가지 요구 사항을 모두 충족하는 솔루션 중 하나이다.

## What is pgpool-II?
- pgpool-II는 애플리케이션과 데이터베이스 사이에서 linux, solaris에서 실행할 수 있는 미들웨어이다.

Feature | Classification | Explanation
--|--|--
Load balancing | 읽기 전용 쿼리르 여러 데이터베이스 서버에 효율적으로 분산하여 더 많은 쿼리를 처리할 수 있다. | Performance improvement
Connection pooling | 데이터베이스에 대한 연결을 유지/재사용하여 연결 오버헤드를 줄이고 재연결 시 성능을 개선한다. | Performance improvement
Replication | 데이터베이스 이중화를 위해 특정 시점에 여러 데이터베이스 서버에 데이터를 복제한다.(1) | High availability of databases
Automatic failover | 기본 데이터베이스 서버에 장애가 발생하면 자동으로 대기 서버로 전환하여 작업을 계속한다. | High availability of databases
Online recovery | 작업을 중단하지 않고 데이터베이스 서버를 복원하거나 추가한다. | High availability of databases
Watchdog | 여러 개의 pgpool-II 인스턴스를 연결하고, 하트비트 모니터링을 수행하며, 서버 정보를 공유한다. 장애가 발생하면 자율적으로 전환이 수행된다. | High availability of pgpool-II

(1) : pgpool-II는 자체 복제 기능 또는 다른 소프트웨어에서 제공하는 복제 기능을 사용할 수 있지만, PostgreSQL의 스트리밍 복제를 사용하는 것이 좋음. 스트리밍 복제는 PostgreSQL(기본)의 트랜잭션 로그(WAL)를 여러 PostgreSQL 인스턴스(대기)로 전송하여 데이터베이스를 복제하는 기능이다. 이 기능은 "https://www.postgresql.fastware.com/postgresql-insider-ha-str-rep" 문서에 설명되어 있습니다.

### 로드 밸런싱 및 연결 풀링
- 스케일아웃은 서버를 추가하여 전체 데이터베이스 시스템의 처리 용량을 늘리는 한 가지 방법이다. PostgreSQL을 사용하면 스트리밍 복제를 사용하여 스케일아웃 할 수 있다. 이 시나리오에서 애플리케이션에서 데이터베이스 서버로 쿼리를 효율적으로 배포하는 것이 필수적이다. PostgreSQL 자체에는 배포 기능이 없지만, 읽기 전용 쿼리를 효율적으로 배포하여 워크로드의 균형을 맞추는 pgpool-II의 로드밸런싱을 활용할 수 있다.
- 또 다른 훌륭한 pgpool-II 기능은 연결 풀링이다. pgpool-II의 연결 풀링을 사용하면 연결을 유지하고 재사용할 수 있으므로 데이터베이스 서버에 연결할 때 발생하는 오버헤드를 줄일 수 있다.

- 로드 밸런싱 및 연결 풀링 기능을 사용하려면 pgpool.conf에서 관련 매개 변수를 설정해야 한다.

### 자동 페일오버 및 온라인 복구
- 이 섹션에서는 pgpool-II를 사용한 자동 페일오버 및 온라인 복구에 대해 설명한다. 이 설명에서는 PostgreSQL의 스트리밍 복제를 사용한다고 가정한다.
- 아래 다이어그램은 pgpool-II가 PostgreSQL(기본)에서 오류를 감지하면 자동 페일오버를 수행하는 방법을 보여준다.
    1. 장애가 발생한 주 서버를 분리하고 Pgpool-II에서 쿼리 배포를 중지한다.
    2. 대기 서버를 새 주 서버로 승격한다.
    3. 각 PostgreSQL에 대한 복제 동기화 위치를 변경한다.
    - 2, 3번에 대한 스크립트를 미리 생성하여 Pgpool-II에 설정한다.
- 온라인 복구 기능은 Pgpool-II에서 온라인 복구 명령을 실행하여 분리된 이전 PostgreSQL(기본)을 PostgreSQL(대기)로 복원한다. 명령 작업은 아래에 설명되어 있다.
    4. 새로운 PostgreSQL(기본)의 데이터를 기반으로 이전 PostgreSQL(기본)을 다시 빌드하고 이를 PostgreSQL(대기)로 복원한다.
    5. 각 PostgreSQL에 대한 복제 동기화 위치 변경
    - 이 프로세스에 대한 스크립트를 미리 작성하여 데이터베이스 서버 측에 저장해야 한다.

### Watchdog
- 전체 시스템의 고가용서을 구현하려면 Pgpool-II 자체도 이중화해야 한다. 이러한 이중화를 위한 이 기능을 워치독이라고 한다.
- 작동 방식은 다음과 같다. 워치독은 활성/대기 설정에서 여러 개의 Pgpool-II 인스턴스를 연결한다. 그런 다음 연결된 Pgpool-II 인스턴스는 상호 하트비트 모니터링을 수행하고 서버 정보(호스트 이름, 포트 번호, pgpool-II 상태, 가상 IP 정보, 시작 시간)을 공유한다. 서비스를 제공하는 Pgpool-II(활성)에 장애가 발생하면 Pgpool-II(대기)가 이를 자율적으로 감지하여 페일오버를 수행한다. 이 때, 새로운 Pgpool-II(활성)는 가상 IP 인터페이스를 시작하고 이전 Pgpool-II(활성)는 가상 IP 인터페이스를 중지한다. 이렇게 하면 서버를 전환한 후에도 애플리케이션 측에서 동일한 IP 주소로 Pgpool-II를 사용할 수 있다. 워치독을 사용하면 데이터베이스 서버 모니터링 및 장애 조치 작업을 수행하기 위해 모든 Pgpool-II 인스턴스가 함께 작동하며, Pgpool-II(활성)가 코디네이터로 작동한다.
- 이러한 작업을 수행하려면 pgpool.conf를 적절히 설정해야 한다.
- 이중화 구성에서는 Pgpool-II와 데이터베이스(PostgreSQL) 모두의 뇌 분열로 인해 발생할 수 있는 결과도 고려해야 한다. 뇌 분열은 활성 서버가 여러 대 존재하는 상황이다. 이 상태에서 데이터를 업데이트하면 데이터 불일치가 발생하고 복구가 번거로워진다. 뇌 분열을 방지하려면 서버를 3개 이상으로 구성하고 서버 수를 홀수로 구성하는 것이 좋다. 다음은 스플릿 브레인이 발생할 수 있는 경우의 예시이다.
    - Pgpool-II의 스플릿 브레인
      2개의 Pgpool-II 인스턴스가 설정되어 있고 이러한 Pgpool-II 인스턴스를 연결하는 네트워크에서만 오류가 발생하면 장애 조치는 발생하지 않지만 Pgpool-II의 조정이 중지된다.
    - 데이터베이스(PostgreSQL)의 스플릿 브레인
      2개의 Pgpool-II 인스턴스가 설정되어 있고 Pgpool-II(활성)와 PostgreSQL(기본)을 연결하는 네트워크에서 오류가 발생하는 경우이다. 2개 인스턴스 설정에서는 장애 조치를 판단하기 위한 투표가 수행되지 않는다.
- 아래는 3개의 Pgpool-II 인스턴스가 있을 때, 데이터베이스에서 분할 브레인 발생을 방지하는 Watchdog의 예시이다.
    1. Pgpool-II(활성)는 자신과 PostgreSQL(기본) 간의 네트워크 연결이 끊어져 발생한 장애를 감지하지만 PostgreSQL(기본)이 실행 중인지 여부는 확인할 수 없다.
    2. 다른 Pgpool-II(대기) 인스턴스는 장애 조치를 판단하기 위해 투표한다.
- 그 후 Pgpool-II 인스턴스가 조치를 취하기로 결정한다.
    3. 과반수 득표가 아니었기 때문에 장애 조치가 없다. 여기서 스플릿 브레인이 방지된다. Pgpool-II(활성)는 PostgreSQL(기본)을 펜싱하여 쿼리 배포를 중지한다.
    4. Pgpool-II(활성)에서 장애가 감지되면 연결이 Pgpool-II(대기)로 전환된다.
- 결과적으로 애플리케이션 측의 업데이트 쿼리는 계속 실행될 수 있다.

## System setup using Pgpool-II
- 여기서는 실제 비즈니스에 기반한 시스템 설정을 제시하고 간단한 작동 점검을 수행한다.

### System setup
- 실제 비즈니스 시나리오를 가정하여 다음 요구 사항을 충족하는 샘플 시스템 설정을 설계하고 Pgpool-II를 활용한다.
    - 스플릿 브레인을 고려한 고가용성 설정
    - 향후 스케일 아웃
    - 성능 향상을 위한 로드 밸런싱 및 연결 풀링

- 일반적으로 하드웨어와 소프트웨어를 선택할 때는 비용 대비 성능을 분석하고 간단하고 효율적인 설정을 목표로 한다. 이 과정에서 첫 번째 요소는 Pgpool-II의 할당이다. 이 과정에서 첫 번째 요소는 Pgpool-II의 할당이다.

Location | Server load | Network | Server cost (quantity)
--- | --- | --- | ---
전용 서버 | 다른 소프트웨어의 영향을 받지 않습니다. | Affected by networks: <br /> - 애플리케이션과 pgpool-II 간의 연결 <br /> - pgpool-II와 데이터베이스 간 연결 | Pgpool-II를 운영하기 위한 추가 서버가 필요함 <br /> 최소 3개부터 시작하여 홀수 개의 서버를 준비하는 것이 좋다.
데이터베이스 서버(coexisting) | 공존하는 데이터베이트의 성능에 영향을 받는다. <br /> 서버의 중복성 및 확장성을 고려해야 한다. | 네트워크에 미치는 영향이 거의 없다. <br /> Pgpool-II와 데이터베이스 간 연결의 일부가 로컬일 수 있다. | 3개 이상의 공존하는 Pgpool-II 서버를 권장한다. <br /> 사용 가능한 데이터베이스 서버의 수에 따라 더 많은 서버가 추가로 필요하다.
애플리케이션 서버 또는 웹 서버(coexisting) | 공존하는 소프트웨어의 성능에 영향을 받는다. <br /> 서버의 중복성 및 확장성을 고려해야 한다. | 네트워크에는 영향을 미치지 않는다. <br /> 애플리케이션(웹 서버)과 Pgpool-II를 로컬로 연결할 수 있다. | 3개 이상의 공존하는 Pgpool-II 서버를 권장한다. <br /> 사용 가능한 애플리케이션 서버 또는 웹 서버의 수에 따라 더 많은 서버가 추가로 필요하다.

### Pgpool-II coexisting on database servers
- 먼저 데이터베이스 서버에 pgpool-II가 공존하는 구성 설정이다.
- 실제 비즈니스 사례에서 사용할 수 있는 실제 시스템 설정을 가정한다. 아래 그림과 같이 클라이언트의 요청은 로드 밸런서에 의해 분산되고, 애플리케이션은 3개의 애플리케이션 서버에서 병렬로 실행된다.
- 여러 개의 pgpool-II 인스턴스가 워치독과 함께 작동한다. 스케일아웃을 위해 데이터베이스 서버 3에 PostgreSQL(대기)을 추가한 다음 필요에 따라 서버를 더 추가한다.
- 이 설정에서는 워크로드가 pgpool-II(활성)가 실행되는 데이터베이스 서버에 집중된다는 점에 유의해야 한다. 로드 밸런스를 계산할 때 이 점을 고려해야 한다.

### Pgpool-II coexisting on application servers
- 다음으로 애플리케이션 서버에 Pgpool-II가 공존하는 샘플 설정이다.
- Pgpool-II는 멀티 마스터 구성으로 작동하므로 고정 IP가 할당된다. 좋은 점은 다음과 같다.
    - Pgpool-II의 로드 밸런싱
    - 업데이트 및 읽기 전용 쿼리는 Pgpool-II(활성) 및 Pgpool-II(대기)에서 허용된다.
    - 애플리케이션과 Pgpool-II간의 네트워크 오버헤드 감소
- 다중 마스터 구성에서도 Pgpool-II(활성)가 데이터베이스를 제어하는 코디네이터로 유지된다. 스케일 아웃을 위해 세 번째 데이터베이스 서버 등을 추가할 수 있다.