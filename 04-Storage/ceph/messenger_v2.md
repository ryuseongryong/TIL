- https://docs.ceph.com/en/latest/rados/configuration/msgr2/

# Messenger v2

## What is it
메신저 v2 프로토콜, 즉 msgr2는 Ceph의 온와이어 프로토콜의 두 번째 주요 개정판입니다. 여기에는 몇 가지 주요 기능이 포함되어 있습니다:

네트워크를 통해 전달되는 모든 데이터를 암호화하는 보안 모드

인증 페이로드의 캡슐화가 개선되어 향후 Kerberos와 같은 새로운 인증 모드를 통합할 수 있습니다.

초기 기능 광고 및 협상이 개선되어 향후 프로토콜 개정이 가능합니다.

이제 Ceph 데몬이 여러 포트에 바인딩할 수 있으므로 기존 Ceph 클라이언트와 새로운 v2 지원 클라이언트가 모두 동일한 클러스터에 연결할 수 있습니다.

기본적으로 모니터는 이제 새로운 v2 프로토콜의 경우 새로운 IANA 할당 포트 3300(ce4h 또는 0xce4)에 바인딩되며, 기존 v1 프로토콜의 경우 기존 기본 포트 6789에도 바인딩됩니다.

## Address Format
노틸러스 이전에는 모든 네트워크 주소가 1.2.3.4:567/89012와 같이 네트워크에서 클라이언트나 데몬을 고유하게 식별하기 위한 IP 주소, 포트, 논스가 있는 형태로 렌더링되었습니다. 노틸러스부터는 이제 세 가지 주소 유형이 있습니다:

- v2: v2:1.2.3.4:578/89012는 새로운 v2 프로토콜을 사용하는 포트에 바인딩된 데몬을 식별합니다.

- v1: v1:1.2.3.4:578/89012는 레거시 v1 프로토콜을 사용하는 포트에 대한 데몬 바인딩을 식별합니다. 이전에 접두사로 표시되던 모든 주소는 이제 v1: 주소로 표시됩니다.

- TYPE_ANY any:1.2.3.4:578/89012는 프로토콜의 두 버전을 모두 사용할 수 있는 클라이언트를 식별합니다. 노틸러스 이전에는 클라이언트가 1.2.3.4:0/123456으로 표시되며, 여기서 0 포트는 클라이언트로서 들어오는 연결을 수락하지 않음을 나타냅니다. 노틸러스부터 이러한 클라이언트는 이제 내부적으로 TYPE_ANY 주소로 표시되며, 데몬이 사용하는 프로토콜에 따라 v2 또는 v1 프로토콜을 사용하여 데몬에 연결할 수 있으므로 접두사 없이 여전히 표시됩니다.

이제 데몬은 여러 포트에 바인딩되므로 단일 주소가 아닌 주소 벡터로 설명됩니다. 예를 들어, 이제 노틸러스 클러스터에서 모니터 맵을 덤프할 때 다음과 같은 줄이 포함됩니다:

```
epoch 1
fsid 50fcf227-be32-4bcb-8b41-34ca8370bd16
last_changed 2019-02-25 11:10:46.700821
created 2019-02-25 11:10:46.700821
min_mon_release 14 (nautilus)
0: [v2:10.0.0.10:3300/0,v1:10.0.0.10:6789/0] mon.foo
1: [v2:10.0.0.11:3300/0,v1:10.0.0.11:6789/0] mon.bar
2: [v2:10.0.0.12:3300/0,v1:10.0.0.12:6789/0] mon.baz
```

괄호로 묶인 주소 목록 또는 벡터는 동일한 데몬이 여러 포트(및 프로토콜)에서 연결될 수 있음을 의미합니다. 해당 데몬에 연결하는 클라이언트나 다른 데몬은 가능한 경우 v2 프로토콜(첫 번째 나열)을 사용하며, 그렇지 않으면 레거시 v1 프로토콜로 돌아갑니다. 레거시 클라이언트는 v1 주소만 표시되며 이전과 마찬가지로 v1 프로토콜로 계속 연결됩니다.

Nautilus부터 mon_host 구성 옵션과 -m <mon-host> 명령줄 옵션은 동일한 대괄호로 묶인 주소 벡터 구문을 지원합니다.

### BIND CONFIGURATION OPTIONS

두 가지 새로운 구성 옵션이 v1 및/또는 v2 프로토콜 사용 여부를 제어합니다:

- ms_bind_msgr1 [기본값: true]는 데몬이 v1 프로토콜을 사용하는 포트에 바인딩할지 여부를 제어합니다.
- ms_bind_msgr2 [기본값: true]는 데몬이 v2 프로토콜을 사용하는 포트에 바인딩할지 여부를 제어합니다.

마찬가지로 두 가지 옵션은 IPv4 및 IPv6 주소 사용 여부를 제어합니다:

- ms_bind_ipv4 [기본값: true]는 데몬이 IPv4 주소에 바인딩할지 여부를 제어합니다.
- ms_bind_ipv6 [기본값: false]는 데몬이 IPv6 주소에 바인딩할지 여부를 제어합니다.

- 참고
여러 포트에 바인딩하는 기능으로 듀얼 스택 IPv4 및 IPv6 지원의 길이 열렸습니다. 단, 듀얼 스택 작동은 아직 Quincy v17.2.0부터 지원되지 않습니다.

## Connection modes
v2 프로토콜은 두 가지 연결 모드를 지원합니다:

- crc 모드는
    - 연결이 설정될 때 강력한 초기 인증(중간자 또는 도청기로부터 보호되는 양 당사자의 상호 인증인 Cephx 사용), 그리고 다음과 같은 기능을 제공합니다.
    - 하드웨어 또는 우주선으로 인한 비트 플립을 방지하기 위한 crc32c 무결성 검사

- crc 모드는 제공하지 않습니다:
    - 비밀성(네트워크의 도청자가 모든 인증 후 트래픽이 지나가는 것을 볼 수 있음) 또는
    - 악의적인 중간자(man-in-the-middle)로부터의 보호(crc32c 값을 일치하도록 조정하는 데 주의를 기울인다면 트래픽이 지나갈 때 의도적으로 수정할 수 있음)

- 보안 모드는 다음을 제공합니다:
    - 연결이 설정될 때 강력한 초기 인증(중간자 또는 도청기로부터 보호되는 양 당사자의 상호 인증인 Cephx 사용), 그리고 다음과 같은 기능을 제공합니다.
    - 암호화 무결성 검사를 포함한 모든 인증 후 트래픽의 완전한 암호화.

Nautilus에서 보안 모드는 일반적으로 최신 프로세서에서 매우 빠른(예: SHA-256 암호화 해시보다 빠른) AES-GCM 스트림 암호를 사용합니다.

## Compression modes
v2 프로토콜은 두 가지 압축 모드를 지원합니다:

- 강제 모드가 제공됩니다:

    - 다중 가용성 영역 배포에서 OSD 간 복제 메시지를 압축하면 지연 시간이 줄어듭니다.
    - 퍼블릭 클라우드에서 AZ 간 통신은 비용이 많이 듭니다. 따라서 메시지 크기를 최소화하면 클라우드 제공업체의 네트워크 비용이 절감됩니다.
    - AWS(다른 퍼블릭 클라우드도 마찬가지일 것입니다)에서 인스턴스 스토리지를 사용할 때 NVMe를 사용하는 인스턴스는 장치 대역폭에 비해 상대적으로 낮은 네트워크 대역폭을 제공합니다. 이 경우 병목 현상이 발생하므로 NW 압축을 통해 전반적인 성능을 개선할 수 있습니다.

- 없음 모드는 제공하지 않습니다:
    - 메시지가 압축되지 않고 전송됩니다.

## TRANSITIONING FROM V1-ONLY TO V2-PLUS-V1
기본적으로 ms_bind_msgr2는 노틸러스 14.2.z부터 참입니다. 그러나 모니터가 v2를 사용하기 시작할 때까지는 제한된 서비스만 v2 주소를 광고하기 시작합니다.

대부분의 사용자의 경우 모니터는 v1 프로토콜의 기본 레거시 포트 6789에 바인딩됩니다. 이 경우 v2를 사용 설정하는 방법은 다음과 같이 간단합니다:

```ceph mon enable-msgr2```
모니터가 비표준 포트에 바인딩되어 있는 경우에는 v2용 추가 포트를 명시적으로 지정해야 합니다. 예를 들어 모니터 mon.a가 1.2.3.4:1111에 바인딩되어 있고 포트 1112에 v2를 추가하려는 경우 다음과 같이 하세요:

```ceph mon set-addrs a [v2:1.2.3.4:1112,v1:1.2.3.4:1111]```
모니터가 v2에 바인딩되면 각 데몬은 다음에 다시 시작될 때 v2 주소를 광고하기 시작합니다.

## UPDATING CEPH.CONF AND MON_HOST
노틸러스 이전에는 일반적으로 CLI 사용자 또는 데몬이 /etc/ceph/ceph.conf의 mon_host 옵션을 통해 모니터를 검색했습니다. 이 옵션의 구문은 새로운 괄호로 묶인 목록 형식을 지원할 수 있도록 노틸러스부터 확장되었습니다. 예를 들어 다음과 같은 이전 줄은

```mon_host = 10.0.0.1:6789,10.0.0.2:6789,10.0.0.3:6789```
로 변경할 수 있습니다:

```mon_host = [v2:10.0.0.1:3300/0,v1:10.0.0.1:6789/0],[v2:10.0.0.2:3300/0,v1:10.0.0.2:6789/0],[v2:10.0.0.3:3300/0,v1:10.0.0.3:6789/0]```
그러나 기본 포트(3300 및 6789)를 사용하는 경우 생략할 수 있습니다:

```mon_host = 10.0.0.1,10.0.0.2,10.0.0.3```
모니터에서 v2를 사용하도록 설정한 후에는 포트를 지정하지 않거나(일반적으로 가장 간단한 방법) v2 및 v1 주소를 모두 명시적으로 지정하도록 ceph.conf를 업데이트해야 할 수 있습니다. 그러나 새로운 대괄호 구문은 Nautilus 이상에서만 이해되므로 아직 ceph 패키지를 업그레이드하지 않은 호스트에서는 이 변경을 하지 마세요.

ceph.conf를 업데이트할 때 모니터에 전달하기에 충분한 정보만 포함된 베어본 구성 파일을 생성하는 새로운 ceph config generate-minimal-conf 명령과 구성 파일 옵션을 모니터의 구성 데이터베이스로 이동하는 ceph config assimilate-conf 명령이 도움이 될 수 있습니다. 예를 들면 다음과 같습니다:

```
# ceph config assimilate-conf < /etc/ceph/ceph.conf
# ceph config generate-minimal-config > /etc/ceph/ceph.conf.new
# cat /etc/ceph/ceph.conf.new
# minimal ceph.conf for 0e5a806b-0ce5-4bc6-b949-aa6f68f5c2a3
[global]
        fsid = 0e5a806b-0ce5-4bc6-b949-aa6f68f5c2a3
        mon_host = [v2:10.0.0.1:3300/0,v1:10.0.0.1:6789/0]
# mv /etc/ceph/ceph.conf.new /etc/ceph/ceph.conf
```