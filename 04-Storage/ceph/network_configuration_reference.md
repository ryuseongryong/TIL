- https://docs.ceph.com/en/latest/rados/configuration/network-config-ref/

# NETWORK CONFIGURATION REFERENCE

고성능 Ceph 스토리지 클러스터를 구축하려면 네트워크 구성이 중요합니다. Ceph 스토리지 클러스터는 Ceph 클라이언트를 대신하여 요청 라우팅이나 디스패치를 수행하지 않습니다. 대신, Ceph 클라이언트는 Ceph OSD 데몬에 직접 요청을 합니다. Ceph OSD 데몬은 Ceph 클라이언트를 대신하여 데이터 복제를 수행하므로, 복제 및 기타 요인으로 인해 Ceph 스토리지 클러스터 네트워크에 추가 부하가 발생합니다.

빠른 시작 구성은 모니터 IP 주소와 데몬 호스트 이름만 설정하는 간단한 Ceph 구성 파일을 제공합니다. 클러스터 네트워크를 지정하지 않는 한, Ceph는 단일 "공용" 네트워크를 가정합니다. Ceph는 공용 네트워크에서만 정상적으로 작동하지만 대규모 클러스터에서 두 번째 "클러스터" 네트워크를 사용하면 성능이 크게 향상될 수 있습니다.

공용(클라이언트, 프론트사이드) 네트워크와 클러스터(프라이빗, 복제, 백사이드) 네트워크의 두 가지 네트워크로 Ceph 스토리지 클러스터를 실행할 수 있습니다. 그러나 이 방식은 네트워크 구성(하드웨어 및 소프트웨어 모두)을 복잡하게 만들며 일반적으로 전체 성능에 큰 영향을 미치지 않습니다. 따라서 복원력과 용량을 위해 듀얼-NIC 시스템에서는 이러한 인터페이스를 액티브/액티브 본드하거나 FRR과 같은 레이어 3 다중 경로 전략을 구현하는 것이 좋습니다.

복잡함에도 불구하고 여전히 두 개의 네트워크를 사용하려는 경우, 각 Ceph 노드에는 둘 이상의 네트워크 인터페이스 또는 VLAN이 있어야 합니다. 자세한 내용은 하드웨어 권장 사항 - 네트워크를 참조하세요.

## IP TABLES
기본적으로 데몬은 6800:7300 범위 내의 포트에 바인딩됩니다. 재량에 따라 이 범위를 구성할 수 있습니다. IP 테이블을 구성하기 전에 기본 iptables 구성을 확인하세요.

```
sudo iptables -L

```
일부 Linux 배포판에는 모든 네트워크 인터페이스에서 SSH를 제외한 모든 인바운드 요청을 거부하는 규칙이 포함되어 있습니다. 예를 들어


```
REJECT all -- anywhere anywhere reject-with icmp-host-prohibited

```
처음에는 퍼블릭 네트워크와 클러스터 네트워크 모두에서 이러한 규칙을 삭제하고 Ceph 노드에서 포트를 강화할 준비가 되면 적절한 규칙으로 교체해야 합니다.

### MONITOR IP TABLES
Ceph 모니터는 기본적으로 3300 및 6789 포트에서 수신 대기합니다. 또한 Ceph 모니터는 항상 공용 네트워크에서 작동합니다. 아래 예제를 사용하여 규칙을 추가할 때 {iface}를 공용 네트워크 인터페이스(예: eth0, eth1 등)로, {ip-address}를 공용 네트워크의 IP 주소로, {netmask}를 공용 네트워크의 넷마스크로 대체해야 합니다:

```
sudo iptables -A INPUT -i {iface} -p tcp -s {ip-address}/{netmask} --dport 6789 -j ACCEPT

```

### MDS AND MANAGER IP TABLES
Ceph 메타데이터 서버 또는 Ceph 관리자는 공용 네트워크에서 포트 6800부터 시작하여 사용 가능한 첫 번째 포트에서 수신 대기합니다. 이 동작은 결정론적이지 않으므로 동일한 호스트에서 둘 이상의 OSD 또는 MDS를 실행 중이거나 짧은 시간 내에 데몬을 다시 시작하면 데몬이 더 높은 포트에 바인딩될 수 있다는 점에 유의하세요. 기본적으로 6800-7300 범위 전체를 열어야 합니다. 아래 예제를 사용하여 규칙을 추가할 때 {iface}를 공용 네트워크 인터페이스(예: eth0, eth1 등)로, {ip-address}를 공용 네트워크의 IP 주소로, {netmask}를 공용 네트워크의 넷마스크로 바꿔야 합니다.

```
sudo iptables -A INPUT -i {iface} -m multiport -p tcp -s {ip-address}/{netmask} --dports 6800:7300 -j ACCEPT
```

### OSD IP TABLES
기본적으로 Ceph OSD 데몬은 포트 6800부터 시작하여 Ceph 노드에서 사용 가능한 첫 번째 포트에 바인딩됩니다. 이 동작은 결정론적이지 않으므로 동일한 호스트에서 둘 이상의 OSD 또는 MDS를 실행 중이거나 짧은 시간 내에 데몬을 다시 시작하면 데몬이 더 높은 포트에 바인딩될 수 있다는 점에 유의하세요. Ceph 노드에 있는 각 Ceph OSD 데몬은 최대 4개의 포트를 사용할 수 있습니다:

1. 하나는 클라이언트 및 모니터와 대화하기 위한 포트입니다.

2. 하나는 다른 OSD로 데이터를 전송하는 데 사용됩니다.

3. 각 인터페이스에서 하트비트를 위한 포트 2개.

데몬이 실패한 후 포트를 놓지 않고 다시 시작하면 다시 시작된 데몬은 새 포트에 바인딩됩니다. 이 가능성을 처리하려면 전체 6800-7300 포트 범위를 열어야 합니다.

공용 네트워크와 클러스터 네트워크를 별도로 설정하는 경우 클라이언트는 공용 네트워크를 사용하여 연결하고 다른 Ceph OSD 데몬은 클러스터 네트워크를 사용하여 연결하므로 공용 네트워크와 클러스터 네트워크 모두에 대한 규칙을 추가해야 합니다. 아래 예제를 사용하여 규칙을 추가할 때 {iface}를 네트워크 인터페이스(예: eth0, eth1 등)로, {ip-address}를 IP 주소로, {netmask}를 공용 또는 클러스터 네트워크의 넷마스크로 바꿔야 합니다. 예를 들면 다음과 같습니다:

```
sudo iptables -A INPUT -i {iface}  -m multiport -p tcp -s {ip-address}/{netmask} --dports 6800:7300 -j ACCEPT

```

- 팁
Ceph 메타데이터 서버를 Ceph OSD 데몬과 동일한 Ceph 노드에서 실행하는 경우 공용 네트워크 구성 단계를 통합할 수 있습니다.

## CEPH NETWORKS
Ceph 네트워크를 구성하려면 구성 파일의 [전역] 섹션에 네트워크 구성을 추가해야 합니다. 5분짜리 빠른 시작에서는 클라이언트와 서버가 동일한 네트워크 및 서브넷에 있는 하나의 공용 네트워크를 가정하는 간단한 Ceph 구성 파일을 제공합니다. Ceph는 공용 네트워크에서만 정상적으로 작동합니다. 하지만 Ceph를 사용하면 공용 네트워크에 대한 여러 IP 네트워크 및 서브넷 마스크를 포함하여 훨씬 더 구체적인 기준을 설정할 수 있습니다. 또한 OSD 하트비트, 오브젝트 복제 및 복구 트래픽을 처리하기 위해 별도의 클러스터 네트워크를 설정할 수도 있습니다. 구성에서 설정한 IP 주소를 네트워크 클라이언트가 서비스에 액세스하는 데 사용할 수 있는 공용 IP 주소와 혼동하지 마세요. 일반적인 내부 IP 네트워크는 192.168.0.0 또는 10.0.0.0인 경우가 많습니다.

- 팁

공용 또는 클러스터 네트워크에 대해 둘 이상의 IP 주소와 서브넷 마스크를 지정하는 경우 네트워크 내의 서브넷이 서로 라우팅할 수 있어야 합니다. 또한 IP 테이블에 각 IP 주소/서브넷을 포함시키고 필요에 따라 포트를 열어야 합니다.

- 참고

Ceph는 서브넷에 CIDR 표기법을 사용합니다(예: 10.0.0.0/24).

네트워크 구성이 완료되면 클러스터를 다시 시작하거나 각 데몬을 다시 시작할 수 있습니다. Ceph 데몬은 동적으로 바인딩되므로 네트워크 구성을 변경하는 경우 전체 클러스터를 한 번에 다시 시작할 필요가 없습니다.

### PUBLIC NETWORK
공용 네트워크를 구성하려면 Ceph 구성 파일의 [전역] 섹션에 다음 옵션을 추가하세요.

```
[global]
        # ... elided configuration
        public_network = {public-network/netmask}
```

### CLUSTER NETWORK
클러스터 네트워크를 선언하면 OSD가 클러스터 네트워크를 통해 하트비트, 오브젝트 복제 및 복구 트래픽을 라우팅합니다. 이렇게 하면 단일 네트워크를 사용할 때보다 성능이 향상될 수 있습니다. 클러스터 네트워크를 구성하려면 Ceph 구성 파일의 [전역] 섹션에 다음 옵션을 추가하세요.

```
[global]
        # ... elided configuration
        cluster_network = {cluster-network/netmask}
```

보안 강화를 위해 공용 네트워크나 인터넷에서 클러스터 네트워크에 연결할 수 없도록 하는 것이 좋습니다.

### IPV4/IPV6 DUAL STACK MODE
IPv4/IPv6 이중 스택 모드로 실행하고 공용 및/또는 클러스터 네트워크를 정의하려는 경우 각각에 대해 IPv4 및 IPv6 네트워크를 모두 지정해야 합니다:

```
[global]
        # ... elided configuration
        public_network = {IPv4 public-network/netmask}, {IPv6 public-network/netmask}
```

이는 Ceph가 두 주소 계열 모두에 대해 유효한 IP 주소를 찾을 수 있도록 하기 위한 것입니다.

IPv4 또는 IPv6 스택 환경만 원하는 경우 ms 바인드 옵션을 올바르게 설정해야 합니다.

- 참고

IPv4에 바인딩은 기본적으로 사용 설정되어 있으므로 IPv6에 바인딩하는 옵션만 추가하면 실제로는 이중 스택 모드로 전환됩니다. IPv6만 사용하려면 IPv4를 비활성화하고 IPv6를 활성화하세요. 아래의 바인딩을 참조하세요.

## CEPH DAEMONS

모니터 데몬은 각각 특정 IP 주소에 바인딩하도록 구성됩니다. 이러한 주소는 일반적으로 배포 도구에서 구성합니다. Ceph 클러스터의 다른 구성 요소는 일반적으로 ceph.conf 파일의 [global] 섹션에 지정된 mon 호스트 구성 옵션을 통해 모니터를 검색합니다.

```
[global]
    mon_host = 10.0.0.2, 10.0.0.3, 10.0.0.4
```

mon_host 값은 IP 주소 목록이거나 DNS를 통해 조회되는 이름일 수 있습니다. A 또는 AAAA 레코드가 여러 개 있는 DNS 이름의 경우, 모니터를 검색하기 위해 모든 레코드가 조사됩니다. 한 모니터에 도달하면 다른 모든 현재 모니터가 검색되므로 클라이언트가 현재 온라인 상태인 모니터 하나에 도달할 수 있도록 모니터 호스트 구성 옵션이 충분히 최신 상태이면 됩니다.

MGR, OSD 및 MDS 데몬은 사용 가능한 모든 주소에 바인딩되며 특별한 구성이 필요하지 않습니다. 그러나 공개 주소(및/또는 OSD 데몬의 경우 클러스터 주소) 구성 옵션을 사용하여 바인딩할 특정 IP 주소를 지정할 수 있습니다. 예를 들어

```
[osd.0]
        public_addr = {host-public-ip-address}
        cluster_addr = {host-cluster-ip-address}
```

#### One NIC OSD in a Two Network Cluster

일반적으로 두 개의 네트워크가 있는 클러스터에 단일 네트워크 인터페이스가 있는 OSD 호스트를 배포하는 것은 권장하지 않습니다. 그러나 Ceph 구성 파일의 [osd.n] 섹션에 public_addr 항목을 추가하여 OSD 호스트가 공용 네트워크에서 작동하도록 강제할 수 있습니다. 여기서 n은 네트워크 인터페이스가 하나인 OSD의 ID를 나타냅니다. 또한 공용 네트워크와 클러스터 네트워크는 서로 트래픽을 라우팅할 수 있어야 하는데, 보안상의 이유로 권장하지 않습니다.

## NETWORK CONFIG SETTINGS
네트워크 구성 설정은 필요하지 않습니다. Ceph는 클러스터 네트워크를 특별히 구성하지 않는 한 모든 호스트가 공용 네트워크에서 작동한다고 가정합니다.

### PUBLIC NETWORK
공용 네트워크 구성을 통해 공용 네트워크의 IP 주소와 서브넷을 구체적으로 정의할 수 있습니다. 특정 데몬의 public_addr 설정을 사용하여 고정 IP 주소를 구체적으로 할당하거나 public_network 설정을 재정의할 수 있습니다.

- public_network : 공용(프런트사이드) 네트워크의 IP 주소 및 넷마스크(예: 192.168.0.0/24)입니다. [global]에서 설정합니다. 쉼표로 구분된 서브넷을 지정할 수 있습니다. 형식은 {ip- address}/{netmask} [, {ip-address}/{netmask}]

- public_addr : 공용(프론트사이드) 네트워크의 IP 주소입니다. 각 데몬에 대해 설정합니다.

### CLUSTER NETWORK
클러스터 네트워크 구성을 통해 클러스터 네트워크를 선언하고 클러스터 네트워크의 IP 주소와 서브넷을 구체적으로 정의할 수 있습니다. 정적 IP 주소를 구체적으로 할당하거나 특정 OSD 데몬에 대해 cluster_addr 설정을 사용하여 cluster_network 설정을 재정의할 수 있습니다.

- cluster_network : 클러스터(백사이드) 네트워크의 IP 주소 및 넷마스크(예: 10.0.0.0/24)입니다. [global]에서 설정합니다. 쉼표로 구분된 서브넷을 지정할 수 있습니다. 형식은 {ip- address}/{netmask} [, {ip-address}/{netmask}]

- cluster_addr : 클러스터(백사이드) 네트워크의 IP 주소입니다. 각 데몬에 대해 설정합니다.

### BIND
바인드 설정은 Ceph OSD 및 MDS 데몬이 사용하는 기본 포트 범위를 설정합니다. 기본 범위는 6800:7300입니다. IP 테이블 구성에서 구성된 포트 범위를 사용할 수 있는지 확인하세요.

Ceph 데몬이 IPv4 주소 대신 IPv6 주소에 바인딩하도록 설정할 수도 있습니다.

- ms_bind_port_min : OSD 또는 MDS 데몬이 바인딩할 최소 포트 번호입니다.
- ms_bind_port_max : OSD 또는 MDS 데몬이 바인딩할 최대 포트 번호입니다.
- ms_bind_ipv4 : Ceph 데몬이 IPv4 주소에 바인딩할 수 있도록 합니다.
- ms_bind_ipv6 : Ceph 데몬이 IPv6 주소에 바인딩할 수 있도록 합니다.
- public_bind_addr : 일부 동적 배포에서는 Ceph MON 디먼이 네트워크의 다른 피어에 알린 public_addr과 다른 로컬 IP 주소에 바인딩할 수 있습니다. 환경에서는 라우팅 규칙이 올바르게 설정되어 있는지 확인해야 합니다. public_bind_addr가 설정되어 있으면 Ceph 모니터 데몬은 로컬로 바인딩하고 monmaps에서 public_addr를 사용하여 피어에게 해당 주소를 알립니다. 이 동작은 모니터 데몬으로 제한됩니다.

### TCP
Ceph는 기본적으로 TCP 버퍼링을 비활성화합니다.

- ms_tcp_nodelay : Ceph는 각 요청이 버퍼링 없이 즉시 전송되도록 ms_tcp_nodelay를 활성화합니다. Nagle의 알고리즘을 비활성화하면 네트워크 트래픽이 증가하여 지연 시간이 발생할 수 있습니다. 작은 패킷이 많이 발생하는 경우 ms_tcp_nodelay를 비활성화해 볼 수 있습니다.
- ms_tcp_rcvbuf : 네트워크 연결의 수신 측에 있는 소켓 버퍼의 크기입니다. 기본적으로 비활성화됩니다.

### GENERAL SETTINGS
- ms_type : 비동기 메신저에서 사용하는 전송 유형입니다. async+posix, async+dpdk 또는 async+rdma일 수 있습니다. Posix는 표준 TCP/IP 네트워킹을 사용하며 기본값입니다. 다른 전송은 실험적일 수 있으며 지원이 제한될 수 있습니다.
- ms_async_op_threads : 각 비동기 메신저 인스턴스에서 사용하는 초기 워커 스레드 수입니다. 최소한 최대 복제본 수와 같아야 하지만, CPU 코어 수가 부족하거나 단일 서버에서 많은 OSD를 호스팅하는 경우 이 값을 줄일 수 있습니다.
- ms_initial_backoff : 장애 발생 시 다시 연결하기 전에 대기할 초기 시간입니다.
- ms_max_backoff : 장애 발생 시 다시 연결하기 전까지 대기할 최대 시간입니다.
- MS_DIE_ON_BAD_msg : 디버그 옵션; 구성하지 않습니다.
- ms_dispatch_throttle_bytes : 발송 대기 중인 메시지의 총 크기를 조절합니다.
- ms_inject_socket_failures : 디버그 옵션; 구성하지 않습니다.
