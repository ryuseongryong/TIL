# Monitoring Services
- https://docs.ceph.com/en/latest/cephadm/services/monitoring/

- Ceph 대시보드는 Prometheus, Grafana 및 관련 도구를 사용하여 클러스터 사용률 및 성능에 대한 자세한 메트릭을 저장하고 시각화한다. Ceph 사용자에게는 세 가지 옵션이 있다.
    1. cephadm이 이러한 서비스를 배포하고 구성하도록 한다. 이 옵션은 `--skip-monitoring-stack` 옵션을 사용하지 않는 한 새 클러스터를 부트스트랩할 때 기본값으로 사용된다.
    2. 이러한 서비스를 수동으로 배포하고 구성한다. 이 방법은 사용자 환경에 기존 prometheus 서비스가 있는 경우(그리고 Ceph가 Rook과 함께 쿠버네티스에서 실행되는 경우)에 권장된다.
    3. 모니터링 스택을 건너뛰는 것. 일부 Ceph 대시보드 그래프를 사용할 수 없다.

- 모니터링 스택은 Prometheus, Prometheus exporters(prometheus module, node exporter), Prometheus Alertmanager, Grafana로 구성된다.

- 참고 사항
    - Prometheus의 보안 모델은 신뢰할 수 없는 사용자가 Prometheus HTTP 엔드포인트 및 로그에 액세스할 수 있다고 가정한다. 신뢰할 수 없는 사용자는 데이터베이스에 포함된 Prometheus가 수집하는 모든 (메타)데이터와 다양한 운영 및 디버깅 정보에 액세스할 수 있다.
    - 그러나 Prometheus의 HTTP API는 읽기 전용 작업으로 제한된다. API를 사용하여 구성을 변경할 수 없으며 비밀이 노출되지 않는다. 또한 Prometheus에는 서비스 거부 공격의 영향을 완화하기 위한 몇 가지 기본 제공 조치가 있다.

## Deploying Monitoring with Cephadm
- cephadm의 기본 동작은 기본 모니터링 스택을 배포하는 것이다. 그러나 모니터링 스택이 없는 Ceph 클러스터가 있고 여기에 모니터링 스택을 추가하고 싶을 수도 있다.
- 다음은 모니터링 스택이 없는 Ceph 클러스터를 갖게 된 몇 가지 방법이다.
    - 클러스터를 설치하는 동안 cephadm에 `--skip-monitoring stack` 옵션을 전달했거나, 모니터링 스택이 없는 기존 클러스터를 cephadm 관리로 전환했을 수 있다.

## Centralized Logging in Ceph
- Ceph는 이제 로키 및 프롬테일과 함께 중앙 집중식 로깅을 제공한다. 중앙 집중식 로그 관리(CLM)는 모든 로그 데이터를 통합하여 중앙 리포지토리로 푸시하며, 접근하기 쉽고 사용하기 쉬운 인터페이스를 제공한다. 중앙 집중식 로깅은 사용자의 편의를 위해 설계되었다. 
- 장점
    1. 선형 이벤트 타임라인: 수백 개의 노드에서 발생하는 수천 개의 서로 다른 로그보다 단일 이벤트 체인을 분석하는 것이 문제를 더 쉽게 해결할 수 있다.

    2. 실시간 라이브 로그 모니터링: 수천 개의 서로 다른 소스로부터의 로그를 추적하는 것은 비현실적이다.

    3. 유연한 보존 정책: 데몬별 로그를 사용하면 일반적으로 디스크 사용량을 절약하기 위해 로그 로테이션을 짧은 간격(1~2주)으로 설정한다.

    4. 보안 및 백업 강화: 로그에는 민감한 정보가 포함될 수 있으며 사용 패턴이 노출될 수 있습니다. 또한 중앙 집중식 로깅을 통해 고가용성(HA) 등을 구현할 수 있다.

- Ceph의 중앙 집중식 로그인은 두 가지 새로운 서비스인 로키와 프롬테일을 사용하여 구현된다.
- Loki: 기본적으로 로그 집계 시스템이며 로그를 쿼리하는 데 사용된다. Grafana에서 데이터 소스로 구성할 수 있다.
- Promtail: 시스템에서 로그를 수집하여 Loki에서 사용할 수 있도록 하는 에이전트 역할을 한다.
- 이 두 서비스는 기본적으로 Ceph 클러스터에 배포되지 않는다. 중앙 집중식 로깅을 활성화하려면 대시보드에서 중앙 집중식 로깅 활성화에 설명된 단계를 사용해야한다.

## Network and Ports
모든 모니터링 서비스는 yaml 서비스 사양으로 바인딩하는 네트워크와 포트를 구성할 수 있습니다. 사용자가 명시적으로 프로토콜을 http로 설정하지 않는 한 기본적으로 cephadm은 Grafana 데몬을 구성할 때 https 프로토콜을 사용합니다.

## Using custom images
다른 이미지를 기반으로 모니터링 구성 요소를 설치하거나 업그레이드할 수 있습니다. 이렇게 하려면 먼저 사용할 이미지의 이름을 구성에 저장해야 합니다. 다음과 같은 구성 옵션을 사용할 수 있습니다.

이미지를 변경한 유형의 모니터링 스택 데몬이 이미 실행 중인 경우, 해당 데몬이 실제로 새 이미지를 사용하도록 하려면 해당 데몬을 다시 배포해야 합니다.

- 참고 사항
    - 사용자 지정 이미지를 설정하면 기본값을 덮어쓰지는 않지만 기본값이 재정의됩니다. 기본값은 업데이트가 제공되면 변경됩니다. 사용자 정의 이미지를 설정하면 사용자 정의 이미지를 설정한 컴포넌트를 자동으로 업데이트할 수 없습니다. 업데이트를 설치하려면 구성(이미지 이름 및 태그)을 수동으로 업데이트해야 합니다.

    - 대신 권장 사항을 사용하기로 선택한 경우 이전에 설정한 사용자 지정 이미지를 재설정할 수 있습니다. 그 후에는 기본값이 다시 사용됩니다. 구성 옵션을 재설정하려면 ceph config rm을 사용하세요.

## Using custom configuration files
cephadm 템플릿을 재정의하면 모니터링 서비스에 대한 구성 파일을 완전히 사용자 지정할 수 있습니다.

내부적으로 cephadm은 이미 모든 모니터링 구성 요소에 대한 구성 파일을 생성하기 위해 Jinja2 템플릿을 사용하고 있습니다. 버전 17.2.3부터 cephadm은 Prometheus http 서비스 검색을 지원하며, 이 엔드포인트를 사용하여 임베디드 Prometheus 서비스를 정의 및 관리합니다. 이 엔드포인트는 https://<mgr-ip>:8765/sd/에서 수신 대기하며(포트는 서비스_디스커버리_포트 변수를 통해 구성 가능), http_sd_config 형식으로 스크랩 대상 정보를 반환합니다.

외부 모니터링 스택을 사용하는 고객은 ceph-mgr 서비스 검색 엔드포인트를 사용하여 스크래핑 구성을 받을 수 있습니다. 서버의 루트 인증서는 다음 명령어로 얻을 수 있습니다: ceph orch sd dump cert


각 서비스에 대해 진자2 템플릿을 저장하여 Prometheus, Grafana 또는 Alertmanager의 구성을 사용자 지정할 수 있습니다. 이 템플릿은 해당 종류의 서비스가 배포되거나 재구성될 때마다 평가됩니다. 이렇게 하면 사용자 지정 구성이 유지되고 향후 이러한 서비스를 배포할 때 자동으로 적용됩니다.

- 참고 사항
    - 사용자 정의 템플릿의 구성은 cephadm의 기본 구성이 변경될 때에도 유지됩니다. 업데이트된 구성을 사용하려면 Ceph를 업그레이드할 때마다 사용자 지정 템플릿을 수동으로 마이그레이션해야 합니다.


