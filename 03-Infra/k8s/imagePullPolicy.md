- https://kubernetes.io/docs/concepts/containers/images/#image-pull-policy

## Image Pull Policy
- 컨테이너에 대한 imagePullPolicy와 이미지 태그는 kubelet이 지정된 이미지를 풀하려고 시도할 때 영향을 미친다.
- imagePullPolicy에 설정할 수 있는 값과 이런 값이 미치는 영향의 목록이다.
    - IfNotPresent : 이미지가 로컬에 아직 없는 경우에만 이미지를 가져옴
    - Always : kubelet이 컨테이너를 시작할 때마다 컨테이너 이미지 레지스트리를 쿼리하여 이름을 이미지 다이제스트로 확인함. 로컬에 정확한 다이제스트가 캐시된 컨테이너 이미지가 있는 경우, kubelet은 캐시된 이미지를 사용하고, 그렇지 않은 경우, kubelet은 확인된 다이제스트가 있는 이미지를 가져와서 해당 이미지를 사용하여 컨테이너를 실행함
    - Never : kubelet은 이미지 가져오기를 시도하지 않음. 이미지가 어떻게든 로컬에 존재하는 경우, kubelet은 컨테이너를 시작하려고 시도하지만 그렇지 않으면 시작에 실패함. pre-pulled image를 사용하는 것을 참조.
- 기본 이미지 제공자의 캐싱 시맨틱은 레지스트리에 안정적으로 액세스할 수 있는 한, `imagePullPolicy: Always`도 효율적으로 만든다. 컨테이너 런타임은 다시 다운로드할 필요가 없도록 이미지 레이어가 이미 노드에 있음을 알 수 있다.
- 프로덕션 환경에서 컨테이너를 배포할 때는 실행 중인 이미지 버전을 추적하기 어렵고 제대로 롤백하기가 더 어렵기 때문에 `:latest` 태그를 사용하지 않아야 한다. 시맨틱한 특정 버전을 지정하여 사용하는 것이 좋다.
- 파드가 항상 동일한 버전의 컨테이너 이미지를 사용하도록 하려면 이미지의 다이제스트를 지정할 수 있다. <이미지-이름>:<태그>를 <이미지-이름>@<다이제스트>로 바꾸면 된다.
- 이미지 태그를 사용할 때, 이미지 레지스트리가 해당 이미지의 태그를 나타내는 코드를 변경하면, 이전 코드와 새 코드가 혼합된 파드가 실행될 수 있다. 이미지 다이제스트는 이미지의 특정 버전을 고유하게 식별하므로, 쿠버네티스는 해당 이미지 이름과 다이제스트가 지정된 컨테이너를 시작할 때마다 동일한 코들르 실행한다. 다이제스트로 이미지를 지정하면 실행하는 코드가 수정되어 레지스트리의 변경으로 인해 버전이 혼합되지 않도록 한다.
- 파드가 생성될 때 파드(및 파드 템플릿)를 변경하여 실행 중인 워크로드가 태그가 아닌 이미지 다이제스트를 기반으로 정의되도록 하는 서드 파트 어드미션 컨트롤러가 있다. 레지스트리에서 태그가 변경되더라도 모든 워크로드가 동일한 코드를 실행하고 있는지 확인하려는 경우 유용할 수 있다.

## Default image pull policy
- 사용자(또는 컨트롤러)가 API 서버에 새 파드를 제출하면 클러스터는 특정 조건이 충족될 때 imagePullPolicy 필드를 설정한다.
    - imagePullPolicy 필드를 생략하고 컨테이너 이미지의 태그가 `:latest`인 경우, imagePullPolicy는 자동으로 `Always`로 설정된다.
    - imagePullPolicy 필드를 생략하고 컨테이너 이미지에 대한 태그를 지정하지 않으면 imagePullPolicy이 자동으로 `Always`로 설정된다.
    - imagePullPolicy 필드를 생략하고 컨테이너 이미지에 대해 `:latest`이 아닌 태그를 지정하면 imagePullPolicy이 자동으로 `IfNotPresent`로 설정된다.
- 컨테이너의 imagePullPolicy 값은 항상 객체가 처음 생성될 때 설정되며, 나중에 이미지의 태그가 변경되더라도 업데이트 되지 않음
- 이미 배포된 디플로이먼트의 imagePullPolicy 필드는 수동으로 변경해야 한다.

## Required image pull
- 항상 강제로 pull을 수행하려면 다음 중 하나를 수행하면 된다.
    - 컨테이너의 imagePullPolicy를 Always로 설정한다.
    - imagePullPolicy를 생략하고 사용할 이미지의 태그로 :latest를 사용한다. 쿠버네티스는 파드를 제출할 때 정책을 Always로 설정한다.
    - imagePullPolicy와 사용할 이미지의 태그를 생략하면, 쿠버네티스는 파드를 제출할 때 정책을 Always로 설정한다.
    - AlwaysPullImages admission controller를 활성화한다.