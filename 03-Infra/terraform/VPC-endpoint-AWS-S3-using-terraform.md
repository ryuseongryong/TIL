# Creating VPC Endpoint for AWS S3 using Terraform

Amazon Web Services는 고객의 요구 사항과 경험을 분석하여 새로운 기능과 업그레이드를 정기적으로 제공해 온 역사를 가지고 있습니다. S3용 VPC 엔드포인트는 2015년 중반에 AWS에서 도입했습니다. 이 기능은 VPC를 지원되는 AWS 서비스 및 VPC 엔드포인트 서비스에 비공개로 연결할 수 있는 유용한 기능입니다. VPC에서 AWS 서비스로의 비공개 연결은 인스턴스에 인터넷 액세스 권한을 부여하거나 NAT 장치를 사용하는 것보다 훨씬 더 안전한 방법입니다. VPC 엔드포인트와 S3용 VPC 엔드포인트에 대한 자세한 내용은 각각 여기와 여기에서 확인할 수 있습니다.

이 블로그의 제목에서 알 수 있듯이, 저는 Terraform을 사용하여 2개의 서브넷(사설 및 공용)으로 구성된 VPC와 사설 서브넷에서 액세스할 수 있는 S3 서비스를 위한 VPC 엔드포인트로 구성된 Amazon 네트워크를 구축한 경험을 공유하기 위해 이 글을 작성하고 있습니다. 이 작업을 위해 Terraform을 선택한 이유는 스크립트의 작동을 이해하는 데 도움이 되는 대화형 CLI가 있었기 때문입니다. 저희는 자동화 도구로 Terraform을 사용하는 것을 좋아하기 때문에 저희가 작업한 다른 AWS용 스크립트를 보시려면 여기 Github 페이지를 확인해 보세요.

이 주제에 대해 이야기하면서, S3용 VPC 엔드포인트에 대한 Terraform 스크립트 구성을 시작하는 방법을 살펴보겠습니다. 표준 프로세스로서 지역과 프로필에 대해 각각 2개의 변수가 있습니다. 나중에 resource 명령을 사용하여 My_VPC라는 이름의 VPC를 생성합니다.

다음으로, VPC(My_VPC)에 프라이빗 서브넷과 퍼블릭 서브넷을 생성합니다. 이에 대한 코드는 여기에 제공된 스크린샷을 참조하세요. 이 인스턴스가 공용 인터넷에서 액세스되지 않도록 하기 위해 프라이빗 인스턴스에 대해서만 map_public_ip_on_launch 값을 "false"로 설정한 것을 확인할 수 있습니다. 서브넷이 초기화되면 AWS 관리 콘솔에서 서브넷을 인식할 수 있도록 항상 태그를 지정하는 것이 좋습니다.

다음에 무엇을 만들어야 한다고 생각하시나요? 보안 모범 사례로, 항상 요구 사항에 따라 보안 그룹을 생성하는 것이 좋습니다. 따라서 각 서브넷에 대해 2개씩 생성해 보겠습니다.

이제 두 서브넷 모두에 대한 보안 그룹 설정이 완료되었습니다. 여기서 주의할 점은 프라이빗 서브넷에 대한 인바운드 액세스는 퍼블릭 서브넷에서만 가능하다는 점입니다. 후자를 사무실용이라고 생각하거나 원격 사용자에 대한 액세스를 추가하려면 IP를 하드코딩하는 것이 좋습니다. 여기에 제공된 Terraform 명령어를 따라 더 많은 제한을 설정할 수 있습니다. 테스트 목적으로 보안 인프라를 구축하는 데 사용할 수 있는 몇 가지 선택적 명령은 의도적으로 생략했습니다.

다음으로, 인터넷에서 공용 서브넷과 통신할 수 있도록 VPC용 인터넷 게이트웨이를 생성합니다. 그런 다음 VPC에 대한 라우트 테이블을 만들고, 대상 IP 주소를 제공하여 인터넷 액세스를 생성하고, 라우트 테이블을 공용 서브넷과 연결합니다.

이제 사설 서브넷에서 어디로 연결할까요? S3 버킷입니다. 따라서 아래와 같이 약간의 Terraform 코드를 사용하여 S3 버킷을 생성합니다:

아래는 VPC 엔드포인트를 생성하고 이를 VPC 경로 테이블과 연결하는 코드입니다:

작업 중인 지역에 따라 엔드포인트에 올바른 service_name을 입력해야 합니다. 이 설정의 경우 뭄바이 지역에 있으므로 서비스 이름에 ap-south-1이 언급되어 있습니다.

다음으로, 보유하고 있는 각 서브넷에 EC2 인스턴스를 생성합니다.

이미 테라폼을 배우고 계신 분이라면 여기서 끝났다는 것을 알고 계실 것입니다. 네, 그렇게 간단합니다. 테라폼 플랜을 실행한 다음 터미널에서 테라폼 적용 명령을 실행하여 AWS에서 서비스를 초기화하면 됩니다. 이제 컴퓨터에서 퍼블릭 인스턴스에 로그인한 다음 프라이빗 인스턴스로 이동한 후 거기에서 S3 버킷 서비스에 액세스하기만 하면 됩니다.

여기서 우리는 무엇을 달성했을까요? 이전에는 공용 네트워크를 사용하지 않고는 불가능했던 프라이빗 인스턴스에서 S3 서비스에 액세스할 수 있게 되었습니다. VPC 엔드포인트 덕분에 동일한 작업을 수행하기 위해 Amazon 네트워크를 떠날 필요가 없었습니다. 정말 놀랍죠?

여기서 한 가지 덧붙이고 싶은 것은 위 스크립트에 사용된 모든 변수가 같은 폴더에 있는 별도의 파일에 선언되었다는 것입니다. 이는 변수를 선언하는 깔끔한 방법이며 전체 스크립트를 명확하게 파악하는 데에도 도움이 됩니다. VPC 엔드포인트를 사용한 SSM 자동화를 위한 유사한 Terraform 스크립트도 있습니다. 꼭 확인해 보세요. 이 스크립트를 사용하면 공용 인터넷을 사용하지 않고도 안전한 방식으로 인스턴스에 대한 SSM 자동화를 실행할 수 있으므로 더욱 안정적이고 안전한 네트워크를 구축할 수 있습니다.

