- https://docs.k3s.io/upgrades

# Upgrades

## Upgrading your k3s cluster
- 수동 업그레이드에서는 클러스터를 수동으로 업그레이드하는 몇 가지 기술에 대해 설명합니다. 또한 Terraform과 같은 타사 코드형 인프라 도구를 통한 업그레이드를 위한 기초로 사용할 수도 있습니다.

- 자동 업그레이드에서는 랜처의 시스템 업그레이드 컨트롤러를 사용하여 쿠버네티스 네이티브 자동 업그레이드를 수행하는 방법을 설명한다.

## Version-specific caveats
- Traefik: Traefik이 비활성화되어 있지 않은 경우 K3 버전 1.20 이하에서는 Traefik v1이 설치되며, K3 버전 1.21 이상에서는 v1이 아직 설치되어 있지 않은 경우 Traefik v2가 설치됩니다. 이전 Traefik v1에서 Traefik v2로 업그레이드하려면 Traefik 설명서를 참조하여 마이그레이션 도구를 사용하세요.

- K3s 부트스트랩 데이터: 외부 SQL 데이터스토어가 있는 HA 구성에서 K3를 사용 중이고 서버(제어 플레인) 노드가 --token CLI 플래그로 시작되지 않은 경우, 토큰을 지정하지 않고는 더 이상 클러스터에 K3 서버를 추가할 수 없습니다. 백업에서 복원할 때 필요하므로 이 토큰의 사본을 보관해야 합니다. 이전에는 K3에서 외부 SQL 데이터스토어를 사용할 때 토큰을 사용하도록 강제하지 않았습니다.

- 영향을 받는 버전은 <= v1.19.12+k3s1, v1.20.8+k3s1, v1.21.2+k3s1이며, 패치된 버전은 v1.19.13+k3s1, v1.20.9+k3s1, v1.21.3+k3s1입니다.

- 다음과 같이 이미 클러스터에 가입한 서버에서 토큰 값을 검색할 수 있습니다:

```
cat /var/lib/rancher/k3s/server/token
```

- 실험적 Dqlite: 실험용 임베디드 Dqlite 데이터 저장소는 K3s v1.19.1에서 더 이상 사용되지 않습니다. 실험용 Dqlite에서 실험용 임베디드 등으로의 업그레이드는 지원되지 않는다는 점에 유의하세요. 업그레이드를 시도하면 성공하지 못하고 데이터가 손실됩니다.

# Stopping k3s
업그레이드 중 고가용성을 보장하기 위해 K3s 서비스가 중지되어도 K3s 컨테이너는 계속 실행됩니다.

모든 K3s 컨테이너를 중지하고 컨테이너 상태를 재설정하려면 k3s-killall.sh 스크립트를 사용할 수 있습니다.

killall 스크립트는 컨테이너, K3s 디렉터리, 네트워킹 구성 요소를 정리하는 동시에 모든 관련 규칙이 포함된 iptables 체인도 제거합니다. 클러스터 데이터는 삭제되지 않습니다.

서버 노드에서 킬올 스크립트를 실행하려면 다음을 실행합니다:

```
/usr/local/bin/k3s-killall.sh
```

# Manual Upgrades

설치 스크립트를 사용하거나 원하는 버전의 바이너리를 수동으로 설치하여 K3를 업그레이드할 수 있습니다.

참고
업그레이드할 때는 먼저 서버 노드를 한 번에 하나씩 업그레이드한 다음 모든 에이전트 노드를 업그레이드하세요.

## Release Channels
설치 스크립트를 통해 또는 자동 업그레이드 기능을 사용하여 수행한 업그레이드는 여러 릴리스 채널에 연결할 수 있습니다. 다음 채널을 사용할 수 있습니다:

안정 : (기본값) 프로덕션 환경에는 안정이 권장됩니다. 이 릴리스는 커뮤니티 강화 기간을 거쳤습니다.
최신 : 최신 기능을 사용해 보려면 최신을 권장합니다. 이 릴리스는 아직 커뮤니티 강화 기간을 거치지 않은 릴리스입니다.
v1.26(예) : 수명이 종료된 버전을 포함하여 각 쿠버네티스 마이너 버전에 연결된 릴리스 채널이 있다. 이러한 채널은 사용 가능한 최신 패치를 선택하며, 반드시 안정적인 릴리스일 필요는 없다.

전체 최신 채널 목록을 보려면 k3s 채널 서비스 API를 방문하세요. 채널 작동 방식에 대한 자세한 기술 정보는 채널서버 프로젝트를 참조하세요.

팁
K3의 새 버전으로 업그레이드를 시도할 때, Kubernetes 버전 왜곡 정책이 적용됩니다. 업그레이드할 때 플랜이 중간 부 버전을 건너뛰지 않는지 확인해야 한다. 시스템-업그레이드-컨트롤러 자체는 지원되지 않는 Kubernetes 버전 변경에 대해 보호하지 않습니다.

## Upgrade K3s Using the Installation Script

이전 버전에서 K3를 업그레이드하려면 설치 스크립트를 실행할 때 원래 사용한 것과 동일한 구성 옵션을 사용하여 설치 스크립트를 다시 실행하면 됩니다.

참고
INSTALL_K3S_EXEC 변수, K3S_ 변수 및 후행 셸 인수는 모두 설치 스크립트에서 시스템드 유닛 및 환경 파일을 생성하는 데 사용됩니다. 설치 스크립트를 처음 실행할 때 구성을 설정했지만 설치 스크립트를 다시 실행할 때 다시 설정하지 않으면 원래 값이 손실됩니다.

구성 파일의 내용은 설치 스크립트에서 관리되지 않습니다. 설치 스크립트와 독립적인 구성을 원한다면 설치 스크립트에 환경 변수나 인수를 전달하는 대신 구성 파일을 사용해야 합니다.

예를 들어 현재 안정 릴리스로 업그레이드하는 경우입니다:
```
curl -sfL https://get.k3s.io | <EXISTING_K3S_ENV> sh -s - <EXISTING_K3S_ARGS>
```

특정 채널에서 최신 버전(예: 최신)으로 업그레이드하려는 경우 채널을 지정할 수 있습니다:
```
curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=latest <EXISTING_K3S_ENV> sh -s - <EXISTING_K3S_ARGS>
```

특정 버전으로 업그레이드하려면 다음 명령을 실행하면 됩니다:
```
curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=vX.Y.Z-rc1 <EXISTING_K3S_ENV> sh -s - <EXISTING_K3S_ARGS>
```

## Manually Upgrade K3s Using the Binary

또는 K3를 수동으로 업그레이드할 수 있습니다:

릴리스에서 원하는 버전의 K3s 바이너리를 다운로드합니다.
다운로드한 바이너리를 /usr/local/bin/k3s(또는 원하는 위치)에 복사합니다.
이전 k3s 바이너리를 중지합니다.
새 k3s 바이너리 실행

## Restarting K3s
K3 재시작은 systemd 및 OpenRC용 설치 스크립트에서 지원됩니다.

systemd

서버를 수동으로 재시작하려면:
```
sudo systemctl restart k3s
```

k3s agent을 수동으로 다시 시작하려면 다음과 같이 하세요:
```
sudo systemctl restart k3s-agent
```
OpenRC
서버를 수동으로 재시작하려면:
```
sudo service k3s restart
```

k3s agent을 수동으로 다시 시작하려면 다음과 같이 하세요:
```
sudo service k3s-agent restart
```