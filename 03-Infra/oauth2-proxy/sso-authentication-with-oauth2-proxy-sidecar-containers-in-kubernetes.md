- https://levelup.gitconnected.com/sso-authentication-with-oauth2-proxy-sidecar-containers-in-kubernetes-7717fb3ef881

# 쿠버네티스에서 OAuth2 Proxy 사이드카 컨테이너를 사용한 SSO 인증

쿠버네티스 환경 내에서 보안을 강화하기 위해 워크로드를 보호하려면 인증 조치를 구현해야 하는 경우가 많습니다. 그러나 특정 애플리케이션은 헬름 차트 또는 유사한 구성 파일을 통해 활성화하는 기능과 같이 이 요구 사항에 대한 기본 지원이 부족합니다. 많은 서비스가 기본적으로 기본 인증 (사용자 이름과 비밀번호)을 제공하지만, 개발 목적이라면 이것으로 충분할 수 있습니다. 그러나 여러 애플리케이션이 있는 프로덕션 환경에서는 제대로 수행되지 않을 경우 액세스 관리가 어려워집니다.

이 포스팅에서는 싱글 사인온(SSO)을 통해 Kubernetes에서 애플리케이션 액세스 관리를 중앙 집중화하는 방법을 보여드리겠습니다. 또한, Kustomize를 사용하여 Uptime Kuma 모니터링 서비스에서 구현하는 방법도 보여드리겠습니다. 여기에는 프록시 역할을 하는 OAuth2 사이드카 컨테이너를 배포하고, KeyCloak ID 공급자(IdP)로 구성하고, 사용자를 KeyCloak에 연결된 로그인 페이지로 리디렉션하는 작업이 포함됩니다.

먼저 솔루션에 사용하는 기본 용어와 개념부터 살펴보겠습니다.

## 싱글 사인온(SSO)
SSO의 강점은 액세스 제어 구성을 단일 위치에서 중앙 집중화할 수 있다는 점입니다. 기업 내에서 각각 다른 액세스 권한이 필요한 여러 애플리케이션을 실행한다고 상상해 보세요. 일부 서비스는 특정 팀만 액세스할 수 있고, 다른 서비스는 관리자나 매니저만 액세스할 수 있습니다. 서비스별 액세스 제어를 만드는 것은 처음에는 문제가 되지 않을 수 있지만, 사용자가 팀 간에 이동하거나 퇴사하는 경우가 자주 발생하면 문제가 될 수 있습니다. 직원이 퇴사하는 시나리오에서처럼, 잠재적인 악의적인 행동을 방지하기 위해 모든 액세스 권한을 신속하게 취소해야 할 필요가 있습니다. 클릭 한두 번으로 이러한 작업을 수행하는 것이 가장 이상적이며, 이러한 효율성은 대부분 단일 액세스 제어 관리 소스를 통해서만 가능합니다.

싱글 사인온(SSO)에 사용할 수 있는 다양한 ID 공급업체가 있어 중앙 집중식 액세스 제어가 가능합니다. 
Keycloak은 오픈 소스 ID 및 액세스 관리 솔루션으로, 프로덕션 환경에서는 자주 배포했지만 개발 환경에서는 덜 자주 배포했습니다. 처음에는 간단해 보이지만 KeyCloak을 선택하는 것이 그리 간단하지 않을 수 있습니다. 다양한 사용 사례를 다루는 커뮤니티 지원, 실적, 보안 패치를 자랑합니다. 하지만 광범위한 사용자 지정 옵션으로 인해 복잡성이 가중될 수 있으므로 확장성이 없는 엔터프라이즈 시나리오에서는 피하는 것이 좋습니다. 여러 SSO 제공업체 중에서 선택해야 하는 상황이라면 GitHub 또는 GitLab도 고려해 보세요. 궁극적으로 선택은 특정 도구 세트와 권한 관리에 필요한 세분화 수준에 따라 달라집니다.

## OAuth2 프록시(사이드카 컨테이너로)
SSO 인증을 위해 사용자가 로그인 페이지로 쉽게 리디렉션되도록 하려면 프록시를 배포해야 합니다. 특히 이를 위해 oauth2-proxy를 사용하는 옵션이 있습니다. 특정 애플리케이션과 긴밀하게 결합되어 있는 Kubernetes 워크로드를 관리한다는 점을 고려할 때, 사이드카 컨테이너로 배포하는 것이 합리적입니다. 중앙 집중식 인증을 위해 단일 배포로 실행하는 것이 매력적으로 보일 수 있는 시나리오도 있지만, 컨테이너 이미지 크기(~12.8MB)가 작다는 점을 고려하면 분산형 패턴을 선택하는 것이 좋습니다. 이러한 선택은 주로 중앙 관리에서 발생할 수 있는 잠재적인 안정성 및 확장성 문제 때문입니다.

## 사용자 지정
아직 데모 단계에 이르지는 못했지만, 헬름 차트를 사용하여 업티마쿠마 모니터링 서비스를 배포할 계획입니다. 그러나 이 헬름 차트는 본질적으로 SSO 인증을 위한 OAuth2 프록시 사이드카를 지원하지 않습니다. 이 제한을 해결하려면 몇 가지 추가 구성으로 차트를 패치해야 합니다. 가장 효과적인 접근 방식은 Kustomize를 활용하는 것이라고 생각합니다. 이를 통해 원래 헬름 차트를 그대로 유지하면서 적용하려는 변경 사항을 선언적으로 정의할 수 있습니다. Kustomize를 사용하면 헬름 차트의 자체 포크를 만들 필요가 없으므로 최신 업데이트를 차트에 원활하게 통합할 수 있습니다.

