- https://www.keycloak.org/docs/latest/server_admin/#audience-support

청중 지원
이 섹션 편집
문제 신고하기
일반적으로 Keycloak이 배포되는 환경은 Keycloak을 인증에 사용하는 일련의 기밀 또는 공개 클라이언트 애플리케이션으로 구성됩니다.

클라이언트 애플리케이션의 요청을 처리하고 이러한 애플리케이션에 리소스를 제공하는 서비스( OAuth 2 사양의리소스 서버 )도 사용할 수 있습니다. 이러한 서비스는 요청을 인증하기 위해 액세스 토큰 (베어러 토큰)을 보내야 합니다. 이 토큰은 키클로크에 로그인할 때 프런트엔드 애플리케이션에서 가져옵니다.

서비스 간 신뢰도가 낮은 환경에서는 이러한 시나리오가 발생할 수 있습니다:

프런트엔드 클라이언트 애플리케이션은 Keycloak에 대한 인증이 필요합니다.

키클로크는 사용자를 인증합니다.

키클로크는 애플리케이션에 토큰을 발급합니다.

애플리케이션은 토큰을 사용하여 신뢰할 수 없는 서비스를 호출합니다.

신뢰할 수 없는 서비스는 애플리케이션에 대한 응답을 반환합니다. 하지만 애플리케이션 토큰은 보관합니다.

그런 다음 신뢰할 수 없는 서비스는 애플리케이션 토큰을 사용하여 신뢰할 수 있는 서비스를 호출합니다. 신뢰할 수 없는 서비스가 토큰을 오용하여 클라이언트 애플리케이션을 대신하여 다른 서비스에 액세스하기 때문에 보안이 취약해집니다.

이 시나리오는 서비스 간 신뢰 수준이 높은 환경에서는 가능성이 낮지만 신뢰 수준이 낮은 환경에서는 가능성이 높습니다. 일부 환경에서는 신뢰할 수 없는 서비스가 신뢰할 수 있는 서비스에서 데이터를 검색하여 원래 클라이언트 애플리케이션으로 데이터를 반환해야 하므로 이 워크플로우가 올바를 수 있습니다.

무제한 오디언스는 서비스 간에 높은 수준의 신뢰가 존재하는 경우에 유용합니다. 그렇지 않은 경우에는 대상을 제한해야 합니다. 대상을 제한하는 동시에 신뢰할 수 없는 서비스가 신뢰할 수 있는 서비스에서 데이터를 검색하도록 허용할 수 있습니다. 이 경우 신뢰할 수 없는 서비스와 신뢰할 수 있는 서비스가 토큰에 대상자로 추가되어 있는지 확인하세요.

액세스 토큰의 오용을 방지하려면 토큰의 대상을 제한하고 토큰의 대상을 확인하도록 서비스를 구성하세요. 흐름은 다음과 같이 변경됩니다:

프런트엔드 애플리케이션은 Keycloak에 대해 인증합니다.

키클로크는 사용자를 인증합니다.

Keycloak은 애플리케이션에 토큰을 발급합니다. 애플리케이션은 신뢰할 수 없는 서비스를 호출해야 한다는 것을 알고 있으므로 Keycloak으로 전송되는 인증 요청에 scope=<신뢰할 수 없는 서비스>를 배치합니다( 범위 매개변수에 대한 자세한 내용은 클라이언트 범위 섹션 참조).

애플리케이션에 발급된 토큰에는 클라이언트가 이 액세스 토큰을 사용하여 신뢰할 수 없는 서비스를 호출하도록 선언하는 대상("대상": [ "<신뢰할 수 없는 서비스>" ])의 신뢰할 수 없는 서비스에 대한 참조가 포함되어 있습니다.

신뢰할 수 없는 서비스가 토큰을 사용하여 신뢰할 수 있는 서비스를 호출합니다. 신뢰할 수 있는 서비스가 토큰의 대상을 확인하여 신뢰할 수 없는 서비스에 대한 대상만 확인하므로 호출이 성공하지 못합니다. 이 동작은 예상되는 것이며 보안이 손상되지 않습니다.

클라이언트가 나중에 신뢰할 수 있는 서비스를 호출하려면 scope=<신뢰하는 서비스>로 SSO 로그인을 다시 발급하여 다른 토큰을 얻어야 합니다. 그러면 반환된 토큰에 신뢰할 수 있는 서비스가 대상자로 포함됩니다:

```
"audience": [ "<trusted service>" ]
```

이 값을 사용하여 <신뢰할 수 있는 서비스>를 호출합니다.

설정
대상 확인을 설정할 때

어댑터 구성에 verify-token-audience 플래그를 추가하여 서비스가 전송된 액세스 토큰에서 대상을 확인하도록 구성되었는지 확인합니다. 자세한 내용은 어댑터 구성을 참조하세요.

Keycloak에서 발급한 액세스 토큰에 필요한 모든 대상자가 포함되어 있는지 확인하세요. 대상은 다음 섹션에 설명된 대로 클라이언트 역할을 사용하여 추가하거나 하드코딩할 수 있습니다. 하드코딩된 대상을 참조하세요.

