- https://codersociety.com/blog/articles/loki-kubernetes-logging

# Logging in Kubernetes with Loki and the PLG Stack

Loki는 Grafana Labs의 새로운 로그 집계 시스템입니다. 이 시스템은 비용 효율적이고 운영하기 쉽도록 설계되었습니다. 이 문서에서는 로키에 대해 자세히 알아보고, Kubernetes에서 로깅을 위해 PLG 스택(Promtail, 로키, 그라파나)을 사용하는 방법에 대해 설명합니다.

## 로키란 무엇인가?
Loki는 오픈 소스 멀티테넌트 로그 집계 시스템입니다. ELK/EFK 스택과 유사하게 로그를 수집하고 액세스하기 위해 Grafana 및 Promtrail과 함께 사용할 수 있습니다. 고급 데이터 분석과 시각화를 위해 Kibana와 Elasticsearch를 사용할 수 있지만, Loki 기반 로깅 스택은 가볍고 작동하기 쉽도록 하는 데 중점을 둡니다.

Loki는 사용자가 로그를 쿼리할 수 있는 LogQL이라는 쿼리 언어를 제공합니다. Prometheus의 PromQL에서 영감을 얻은 것으로, 로그 소스를 집계하는 분산형 '그렙'으로 간주할 수 있습니다.

기존 로깅 시스템과의 주요 차이점 중 하나는 로키는 로그의 전체 내용이 아닌 메타데이터만 인덱싱한다는 점입니다. 따라서 인덱스의 크기가 작아져 메모리 소비가 줄어들고 궁극적으로 비용도 절감됩니다. 이 설계의 한 가지 단점은 모든 것을 색인하고 메모리에 로드하는 것보다 쿼리 성능이 떨어질 수 있다는 것입니다.

로그는 디스크에 파일을 저장할 필요 없이 Amazon S3 또는 GCS와 같은 클라우드 스토리지에 직접 저장됩니다. 따라서 작업이 간소화되고 디스크 공간 부족과 같은 문제를 방지할 수 있습니다.

## 로키 사용의 8가지 이점
스택에서 로키를 사용하면 얻을 수 있는 몇 가지 주요 이점은 다음과 같습니다:

간편한 사용: 설정이 간단하고 조작이 쉽습니다.

경량: EFK처럼 전체 로그 메시지 대신 메타데이터만 색인합니다. 따라서 Loki 배포에 필요한 RAM 인스턴스 비용이 절감됩니다.

클라우드 네이티브: 포드 레이블과 같은 메타데이터가 자동으로 스크랩되고 인덱싱되는 Kubernetes와 같은 다른 클라우드 네이티브 도구와 함께 잘 작동합니다.

오브젝트 스토리지를 사용합니다: 일반적으로 블록 스토리지를 사용하는 것보다 저렴한 Amazon S3 또는 GCS와 같은 객체 스토리지를 사용합니다.

수평적 확장: 로컬 또는 소규모 작업의 경우 단일 바이너리로 실행할 수 있으며, 대규모 작업의 경우 수평적으로 쉽게 확장할 수 있습니다.

쿼럼 일관성: 읽기 및 쓰기 작업에 Dynamo 스타일의 쿼럼 일관성을 사용하여 균일한 쿼리 결과를 보장합니다.

멀티 테넌시 지원: 테넌트 ID를 통해 테넌트의 데이터를 별도로 저장할 수 있도록 멀티테넌시를 지원합니다.

기본 Grafana 지원: Grafana에서 기본적으로 지원됩니다(Grafana v6.0 필요).

## 로키의 사용 사례
이제 로키의 이점에 대해 이야기했으니, 몇 가지 인기 있는 사용 사례도 살펴보겠습니다:

디버깅 및 문제 해결: Loki는 당면한 문제와 관련된 유용한 정보를 제공하여 DevOps 팀이 문제의 원인을 더 빨리 파악할 수 있도록 도와줍니다. 예를 들어, 문제가 언제 발생했는지, 정확히 어떤 일이 일어났는지, 어떻게 문제가 발생했는지 쉽게 확인할 수 있습니다.

모니터링: Prometheus는 업계에서 모니터링을 위해 널리 사용되고 있습니다. 하지만 로키를 통해 로그를 모니터링하면 많은 문제를 파악할 수 있습니다. 예를 들어, 웹사이트의 오류율을 주시하고 특정 임계값을 초과할 때마다 알림을 수신하는 데 사용할 수 있습니다.

사이버 보안: Loki를 사용하면 회사 시스템의 위협, 문제, 악의적인 활동을 식별할 수 있습니다. 또한 시스템이 이미 손상된 후 공격의 세부 사항을 파악하는 데 도움이 됩니다.

규정 준수: 규정상 기업이 감사 로그를 보관해야 하는 경우, Loki는 신뢰할 수 있고 안전한 옵션입니다.

비즈니스 인텔리전스: Loki는 기술 전문가가 아닌 팀도 로그 데이터를 이해하고 비즈니스 성장을 위한 새로운 전략과 아이디어를 개발할 수 있도록 도와줍니다. 예를 들어, 마케터는 전환율 최적화를 위해 데이터를 사용하여 고객이 어디에서 유입되는지, 어떤 마케팅 채널이 가장 효과적인지, 어떤 채널을 개선해야 하는지 확인할 수 있습니다.

## PLG 스택(프롬테일, 로키, 그라파나)

https://res.cloudinary.com/codersociety/image/fetch/f_webp,w_780/https://cdn.codersociety.com/uploads/loki-plg-stack.png

- Promtail은 애플리케이션이나 서비스를 실행하는 각 노드에 설치해야 하는 에이전트입니다. 로컬 로그 파일과 같은 대상을 감지하고, 포드에서 로그 스트림에 레이블을 첨부한 다음, 이를 Loki로 전송합니다.
- 로키는 PLG 스택의 핵심입니다. 로그 데이터를 저장하는 역할을 합니다.
- Grafana는 Loki의 시계열 데이터를 처리하고 웹 UI에서 로그에 액세스할 수 있도록 하는 오픈소스 시각화 플랫폼입니다.

## 쿠버네티스에서 PLG 스택 시작하기
몇 가지 실습을 통해 Loki를 시작해보겠습니다. 이 예제에서는 Loki 스택을 사용하여 Grafana에서 Kubernetes API 서버의 로그를 시각화해 보겠습니다.

시작하기 전에 Kubernetes 클러스터가 실행 중이고 헬름이 설치되어 있는지 확인하세요. 모든 준비가 완료되면 Loki를 설치하면 됩니다:

### 헬름과 함께 PLG 스택 설치
생략

### LogQL
LogQL은 연산자를 통해 로그를 필터링하는 기능을 제공합니다. 다음은 지원되는 연산자 목록입니다:
- `=:` exactly equal.
- `!=:` not equal.
- `=~:` regex matches.
- `!~:` regex does not match.

다른 쿼리에 대해 시도해 보겠습니다. 먼저 kube-apiserver 컨테이너의 모든 로그를 검색합니다. 여기에 필터 연산자를 추가하여 오류라는 단어가 포함되지만 시간 초과라는 단어는 포함되지 않는 로그로 결과를 제한합니다:
```
{container="kube-apiserver"} |= "error" != "timeout"

```
이것은 로키와 그라파나를 설정하고 작업하는 간단한 예시입니다. 더 자세히 알아보려면 Loki 문서를 참조하세요.

## Wrapping up

기업은 분산된 시스템의 앱과 서비스에서 로그 파일을 수집, 저장, 분석할 수 있는 간단하고 비용 효율적인 솔루션이 필요합니다. Loki는 프로덕션 환경에서 로깅 및 모니터링 비용을 획기적으로 절감할 수 있도록 도와줍니다. Promtail 및 Grafana와 함께 사용하면 전체 로깅 스택에 필요한 모든 기능을 제공하여 문제를 더 빨리 찾아서 해결하고 향후 오작동을 방지할 수 있습니다.