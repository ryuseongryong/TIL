- https://grafana.com/blog/2021/11/16/why-we-created-a-prometheus-agent-mode-from-the-grafana-agent/

# Why we created a Prometheus Agent mode from the Grafana Agent

2021-10-29에 Prometheus 에이전트에 대한 초기 지원이 병합되었으며, Prometheus v2.32에 포함될 예정입니다!

이 기능은 다소 긴 역사를 가지고 있습니다:

- 2020-03-18에는 원격 쓰기로 메트릭을 전송하는 데 TSDB가 필요 없는 Prometheus의 하위 집합인 Grafana 에이전트를 발표했습니다.
- 2020년 12월 17일, Prometheus 팀은 개발자 서밋을 개최하여 공식 Prometheus 프로젝트에서 Grafana 에이전트와 유사한 기능을 다루기로 합의했습니다.
- 2021-01-27에는 Grafana 에이전트 코드를 업스트림으로 이동하여 이를 수행하는 방법에 대한 제안을 게시했습니다.
- 2021-05-05에 Grafana 에이전트 코드를 업스트림으로 이동하는 첫 번째 PR이 공개되었습니다.
- 2021-10-29에 해당 PR은 Prometheus의 메인 브랜치에 병합되었습니다.
현재의 위치에 도달하기까지 시간이 조금 걸렸지만, Grafana 에이전트 코드를 사용하여 prometheus/prometheus 리포지토리에서 에이전트와 유사한 기능을 사용할 수 있게 되어 매우 기쁩니다. 프로메테우스 관리자인 Bartłomiej Płotka는 발표 블로그 게시물에서 에이전트 모드가 수집을 위한 수평적 확장성을 더 쉽게 만들어주며 "CNCF 에코시스템의 특정 배포에 있어 판도를 바꿀 것"이라고 썼습니다.

# Grafana Agent
2020년에 처음 발표했을 때 Grafana 에이전트의 목표는 단 하나였습니다. 바로 실전에서 검증된 동일한 Prometheus 코드를 사용하는 클라우드에 최적화된 Prometheus의 하위 집합이 되는 것이었습니다. 이를 위해 Prometheus를 '에이전트 모드'로 축소하여 TSDB에 의존하는 부분을 제외한 모든 Prometheus 코드를 재사용했습니다.

이 과정에서 몇 가지 독특한 장단점이 있었습니다. Prometheus와 호환되는 원격 쓰기 엔드포인트를 사용하면 메모리와 저장 공간을 덜 사용하지만 쿼리, 규칙 기록, 알림과 같이 TSDB에 의존하는 기능을 로컬에서 잃게 됩니다.

19번의 릴리스 이후, 많은 변화가 있었습니다! 통합이라고 하는 임베디드 Prometheus 내보내기에 대한 지원, Grafana 에이전트를 서비스로 호스팅하는 운영자를 위한 확장 가능한 모드, Grafana Loki-호환 로그에 대한 지원, 마지막으로 Grafana Tempo에 대한 OTLP 추적 지원 등이 그 이후 추가되었습니다.

현재 Grafana 에이전트는 프로젝트의 세 가지 주요 목표를 가지고 있다고 말씀드릴 수 있습니다:

- 의견이 분분한 오픈 소스 텔레메트리 스택의 최고의 동반자가 되겠습니다: 메트릭을 위한 Prometheus, 로그를 위한 Grafana Loki, 추적을 위한 Grafana Tempo. 이 세 가지 프로젝트는 공통점이 많으며 서로 잘 어울립니다.
- 첫 번째 목표에 힘을 실어주는 새로운 사용 사례(누군가가 텔레메트리 데이터를 전달하기 위해 Grafana 에이전트를 사용하는 방법)를 활성화합니다. 호스트 필터링 모드와 스토리지 없이 Prometheus를 사용하는 개념이 그 예입니다.
- 입증된 사용 사례를 더 넓은 에코시스템과 공유하여 오픈 소스 통합 가시성을 전반적으로 강화하세요. 우리는 이미 Prometheus와 SigV4 지원을 공유했을 때 이 작업을 수행했으며, Prometheus 에이전트는 그 또 다른 예입니다.

첫 번째 목표가 모호하지 않은 척하지 않겠습니다. "최고"는 주관적이지만 성능, 호환성, 지원되는 사용 사례의 조합으로 측정할 수 있다고 생각합니다. 활성화된 사용 사례는 두 번째 목표에 해당하며, 사용자, 유지 관리자, 기여자에게 가장 흥미로운 프로젝트가 될 수 있는 부분이기도 합니다.

## Asynchronous collaboration

물론 저희가 혁신의 주인공이 되어 다른 누구도 지원하지 않는 사용 사례를 용감하게 해결하겠다고 주장하는 것은 아닙니다. OpenTelemetry Collector와 같은 프로젝트가 유사한 Prometheus 에이전트 사용 사례를 동시에 지원하고 있습니다. 이러한 점을 고려할 때 두 개의 유사한 솔루션이 병렬로 존재하는 것이 합리적일지 의문이 들 수 있습니다.

저는 오픈 소스가 "비동기식 협업"이라고 부르고 싶은 것을 가능하게 한다고 주장하고 싶습니다. 이 개념은 여러 프로젝트가 여러 접근 방식을 동시에 탐색함으로써 함께 작업할 수 있다는 것입니다. 이러한 병렬화는 결국 모두에게 이익이 되는 더 강력한 솔루션으로 이어집니다. 비동기식 협업은 '경쟁'으로 더 잘 알려져 있지만, 통합 가시성 에코시스템에 대한 이점을 설명하기 위해 여기서는 독특한 용어로 표현하고 싶습니다.

비동기식 협업을 통해 프로젝트는 다양한 관점에서 문제 해결의 범위를 좁힐 수 있으며, 보다 성숙한 접근 방식을 향해 더 빠르게 반복할 수 있습니다. 현재로서는 Grafana 에이전트와 OpenTelemetry Collector는 서로 다른 장단점을 가지고 있으며, 이 두 가지가 통합되는 미래가 올지 알기에는 너무 이르다고 할 수 있습니다. 두 솔루션이 병렬로 존재하는 한, 두 솔루션은 병렬로 반복하면서 다른 솔루션으로부터 교훈을 배울 수 있습니다.

이러한 유형의 협업은 오픈 소스와 개방형 표준을 통해서만 가능한 일이며, 오늘날 단일 접근 방식으로 시작하는 것보다 더 나은 미래로 이어진다고 확신합니다.

## When to contribute?

물론 비동기식 협업은 코드 기부를 통한 것이든 서로 다른 두 가지 아이디어를 하나의 새로운 아이디어로 전환하는 것이든 어떤 목적을 위한 의도가 있을 때만 가치가 있습니다. 이 사이클이 끝나면 두 프로젝트 모두 더 넓은 커뮤니티에서 더 광범위한 사용 사례를 지원함으로써 더욱 강력해집니다.  

코드 기부 경로의 가장 큰 최근 사례는 Prometheus 에이전트라고 생각합니다. 우리는 지난 20개월 동안 Prometheus의 에이전트 개념(즉, Grafana 에이전트의 TSDB가 없는 핵심)을 입증했습니다. 개념이 입증된 지금이 사이클을 종료하고 업스트림으로 옮기기에 완벽한 시기였습니다. Grafana 에이전트 메트릭 코드가 다른 Prometheus 코드에 전적으로 의존하는 방식을 고려할 때, 코드를 Prometheus 프로젝트로 옮기는 것이 합리적입니다.

Prometheus가 에이전트 사용 사례를 공식적으로 지원함으로써 이전에는 의미가 없던 새로운 에이전트 전용 기능을 사용할 수 있는 길이 열렸습니다. 이러한 기능은 결국 Grafana 에이전트에도 적용되어 두 프로젝트를 강화할 수 있습니다.

또한 비동기식 협업 주기를 종료하면 더 많은 주기를 불러올 수도 있습니다: 이제 Prometheus와 Grafana Agent 모두 새로운 사용 사례를 동시에 탐색할 수 있는 기회가 생겼습니다.

## Next steps
이제 프로메테우스 에이전트가 통합되었으므로, 첫 번째 단계는 그라파나 에이전트처럼 안정적으로 운영될 수 있도록 시간을 할애하는 것입니다.

그 다음에는 이 코드를 활용할 수 있는 프로젝트와 코드를 공유하고자 합니다. 예를 들어, 타노스(타노스 룰러의 경우)는 현재 Grafana 에이전트 지표 코드의 사본을 사용하고 있으며, 이제 공식 업스트림 솔루션을 사용하도록 변경할 수 있습니다.

물론 코드 기반이 하나만 남도록 Grafana 에이전트도 Prometheus 에이전트 코드를 사용하도록 업데이트할 예정입니다.

마지막으로, 저희가 확인한 다른 에이전트별 사용 사례에 대한 논의를 시작하여 Prometheus 에이전트와 공유할 수 있도록 할 것입니다.