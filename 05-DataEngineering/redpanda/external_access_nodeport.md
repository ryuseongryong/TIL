- https://docs.redpanda.com/current/manage/kubernetes/networking/external/k-nodeport/

# Configure External Access through a NodePort Service

기본적으로 헬름 차트는 레드판다 브로커의 외부 리스너 포트로 트래픽을 라우팅하는 노드포트 서비스를 배포한다. 이 노드포트 서비스를 사용하여 외부 액세스를 설정하려면, 워커 노드의 IP 주소로 확인되는 주소를 광고하도록 브로커를 구성해야 한다.

## Prerequisites

배포하려는 Redpanda 브로커마다 하나의 작업자 노드가 필요합니다.

로컬 머신에 rpk를 설치하여 쿠버네티스 외부에서 Redpanda 클러스터에 대한 연결을 테스트할 수 있도록 합니다.

쿠버네티스 클러스터 요구사항 및 권장사항을 검토하세요.

Redpanda를 위한 쿠버네티스 네트워킹을 이해한다.

원하는 노드 포트 범위를 통해 Kubernetes 클러스터에 액세스할 수 있는지 확인합니다. 예를 들어, AWS EKS를 사용하는 경우 인바운드 방화벽 규칙을 편집해야 합니다. 그리고 Azure AKS를 사용하는 경우, 노드 풀의 노드에서 공인 IP를 활성화해야 합니다.

브로커가 사용자 지정 도메인을 광고하도록 하려면 해당 도메인의 DNS 설정을 제어할 수 있어야 합니다.

내부 테스트의 경우 해당 도메인을 소유하지 않아도 어떤 도메인이든 사용할 수 있습니다:

- 로컬 DNS 서버가 해당 도메인을 올바른 IP 주소로 확인하도록 구성되어 있습니다.
- 클라이언트 시스템이 확인을 위해 DNS 서버를 사용하도록 구성되어 있습니다.

프로덕션 환경에서는 도메인 등록기관에서 도메인을 구입하는 것이 가장 좋습니다. 이렇게 하면 추가적인 클라이언트 측 구성 없이도 도메인을 확인할 수 있습니다.

## Advertise custom domains
IP 주소가 아닌 사용자 정의 도메인을 광고하면 다음과 같은 몇 가지 장점이 있습니다:

- 유연성: 특히 서비스를 이동하거나 확장 및 축소할 수 있는 클라우드 환경에서는 IP 주소가 변경될 수 있습니다. 도메인 네임을 사용하는 경우 IP 주소가 변경될 때 DNS 레코드를 업데이트할 수 있으며 클라이언트는 구성을 변경할 필요가 없습니다.
- 고가용성: 서버에 장애가 발생하면 도메인 네임을 다른 IP 주소로 신속하게 리디렉팅할 수 있으며, 이는 클라이언트가 IP 주소를 사용하여 직접 연결하는 경우에는 불가능합니다.
- 보안: 서버의 IP 주소가 변경되더라도 도메인 이름에 바인딩되어 있는 경우 TLS 인증서를 다시 발급할 필요가 없습니다.

사용자 정의 도메인을 광고하도록 Redpanda 브로커를 구성하려면 각 브로커에 브로커의 작업자 노드 주소를 가리키는 호스트 네임도 있어야 합니다.

브로커는 다음 호스트 네임 중 하나를 광고할 수 있습니다:

- 기본 Redpanda 호스트 이름

    기본 호스트네임은 redpanda-<ordinal-number>이며, 여기서 redpanda는 헬름 릴리스의 이름이고 <ordinal-number> 자리표시자는 스테이트풀셋에서 생성한 파드 서수이다.

- 사용자 정의 호스트네임

    사용자 정의 호스트네임은 기본값을 재정의한다. 예를 들어, <hostname-for-broker-0>.<custom-domain>을 광고하도록 브로커를 구성할 수 있다.

### Advertise the default Redpanda hostnames
기본적으로 헬름 차트는 각 브로커에 헬름 릴리스와 파드 서수로 구성된 호스트명을 제공한다. 예를 들어, redpanda-0, 여기서 redpanda는 헬름 릴리스이고 0은 파드 서수이다. 이러한 호스트네임으로 브로커를 구성하려면 사용자 정의 도메인으로 브로커를 구성해야 한다.

### Custom hostnames
기본 호스트 네임 대신 광고할 사용자 정의 호스트 네임을 각 Redpanda 브로커에 부여할 수 있습니다. 사용자 정의 호스트 이름에 파드 서수를 붙이거나 완전히 사용자 정의할 수 있습니다.

### Create DNS records
브로커가 사용자 지정 도메인을 광고하도록 구성되면 다음 단계는 브로커가 실행 중인 작업자 노드의 IP 주소로 FQDN을 가리키는 DNS 레코드를 만드는 것입니다. 만들 수 있습니다

### Advertise IP addresses
각 Redpanda 브로커가 실행 중인 워커 노드의 IP 주소를 광고하도록 구성할 수 있습니다.

클러스터에 TLS가 활성화된 경우(기본값), 사용자 지정 도메인을 광고해야 한다. 헬름 차트는 IP 주소가 아닌 사용자 지정 도메인을 TLS 인증서의 SAN 목록에 추가한다. 따라서 안전한 TLS 액세스를 보장하려면 로드밸런서 서비스에 할당된 IP 주소를 DNS 이름으로 확인할 수 있도록 해야 한다.

etc/hosts 파일에 항목을 추가하는 것은 개발 목적에는 적합할 수 있지만 프로덕션 환경에는 적합한 접근 방식이 아닙니다. 프로덕션 환경에서는 조직의 DNS 서비스를 업데이트하여 DNS 이름으로 IP 주소를 확인할 수 있도록 해야 합니다. 조직의 DNS 서비스를 업데이트하면 사용자가 SSL/TLS 경고나 오류 없이 안전하게 서비스에 액세스할 수 있습니다.